{% extends "myapp/base.html" %}
{% load static %}
{% block body %}
  <!-- Navbar Start -->
  <nav
  class="navbar navbar-expand-lg bg-white navbar-light sticky-top py-lg-0 px-4 px-lg-5 wow fadeIn"
  data-wow-delay="0.1s"
  >
  <a href="{% url "index" %}" class="navbar-brand p-0">
    <img class="img-fluid me-3" src="{% static 'myapp/images/icon/icon-10.png' %}" alt="Icon" />
    <h1 class="m-0 text-primary">AfricaVision</h1>
  </a>
  <button
    type="button"
    class="navbar-toggler"
    data-bs-toggle="collapse"
    data-bs-target="#navbarCollapse"
  >
  <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse py-4 py-lg-0" id="navbarCollapse">
    <div class="navbar-nav ms-auto">
      {% if user.is_authenticated %}
      <a class="nav-item nav-link">Xin chào, {{ user.username }}!</a>
      <a href="{% url "history" %}" class="nav-item nav-link">Lịch sử</a>
    </div>
    <a href="{% url 'signout' %}" class="btn btn-primary"> Đăng xuất
    <i class="fa fa-arrow-right ms-3"></i>
    </a>
    {% else %}
    <a href="{% url 'signin' %}" class="btn btn-primary"> Đăng nhập
      <i class="fa fa-arrow-right ms-3"></i>
    </a>
    {% endif %}
  </div>
  </nav>
  <!-- Navbar End -->

  <!-- Header Start -->
  {% if user.is_authenticated %}
  <div class="container-fluid p-0 mb-5">
  <div class="row g-0">
    <div class="col-lg-12 p-0 wow fadeIn" data-wow-delay="0.1s">
      <div
        class="header-bg h-100 d-flex flex-column justify-content-center align-items-center p-5"
      >
        <h1 class="display-4 text-light mb-5 text-center">
          Nhận diện động vật hoang dã Châu Phi
        </h1>
        <input type="file" id="imageUpload" accept="image/*" style="display: none;" />
        <div class="d-flex justify-content-center align-items-center pt-4 animated slideInDown">
          <a class="btn btn-primary py-sm-3 px-3 px-sm-5 me-5" onclick="document.getElementById('imageUpload').click();">
            Tải ảnh
          </a>
          <input type="file" id="videoUpload" accept="video/*" style="display: none;" />
          <button
            type="button"
            class="btn-play"
            onclick="document.getElementById('videoUpload').click();"
          >
            <span></span>
          </button>
          <h6 class="text-white m-0 ms-4 d-none d-sm-block">Tải video</h6>
        </div>
      </div>
    </div>
  </div>
  </div>

  <div class="progress" id="progressBar" style="display: none;">
    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" 
         aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
    </div>
  </div>

  <div class="d-flex justify-content-center">
    <div id="loadingMessage" style="display: none;">Đang tiến hành nhận diện...</div>
  </div>
  
  <!-- Button trigger modal (initially hidden) -->
  <div class="d-flex justify-content-center">
    <button type="button" class="btn btn-primary" id="mediaButton" data-bs-toggle="modal" data-bs-target="#mediaModal" style="display: none;">
      Xem ảnh hoặc video đã tải lên
    </button>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="mediaModal" tabindex="-1" aria-labelledby="mediaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="mediaModalLabel">Ảnh hoặc video đã tải lên</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
          </button>
        </div>
        <div class="modal-body" id="mediaContent">
          <!-- Hiển thị ảnh hoặc video đã tải lên ở đây-->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
          <a href="#" id="downloadLink" class="btn btn-primary">Tải xuống</a>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript xử lý tải lên -->
  <script>
    function handleUpload(inputId) {
      const input = document.getElementById(inputId);
      const mediaButton = document.getElementById('mediaButton');
      const mediaContent = document.getElementById('mediaContent');
      const downloadLink = document.getElementById('downloadLink');
      const loadingMessage = document.getElementById('loadingMessage');

      input.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const progressBar = document.getElementById('progressBar');
        const progress = progressBar.querySelector('.progress-bar');
        progressBar.style.display = 'block';
        progress.style.width = '0%';
        progress.setAttribute('aria-valuenow', 0);
        loadingMessage.style.display = 'block'; // Hiển thị thông báo đang xử lý

        // Mô phỏng thanh tiến trình
        let progressValue = 0;
        const progressInterval = setInterval(() => {
          progressValue += 10;
          progress.style.width = progressValue + '%';
          progress.setAttribute('aria-valuenow', progressValue);
          if (progressValue >= 100) {
            clearInterval(progressInterval);
            progressBar.style.display = 'none';
            loadingMessage.style.display = 'none'; // Chỉ ẩn thông báo khi tiến trình hoàn tất
          }
        }, 200);

        // Gửi file lên server
        const formData = new FormData();
        formData.append('media', file);

        fetch('/upload_media/', { 
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Hiển thị nút xem media
            mediaButton.style.display = 'block';

            // Xóa nội dung media cũ
            mediaContent.innerHTML = '';

            // Tạo phần tử media mới
            if (file.type.startsWith('video/')) {
              // Xử lý video
              const video = document.createElement('video');
              video.src = data.url;
              video.controls = true;
              video.className = 'img-fluid w-100';
              video.type = 'video/mp4'; // Đảm bảo trình duyệt biết định dạng video
              video.onerror = () => {
                alert('Không thể tải video. Vui lòng thử lại hoặc kiểm tra định dạng.');
              };
              mediaContent.appendChild(video);
              downloadLink.href = data.url;
              // Kiểm tra xem video có thể phát được không
              video.load();
              video.play().catch(error => {
                console.error('Lỗi phát video:', error);
              });
            } else {
              // Xử lý ảnh
              const img = document.createElement('img');
              img.src = data.url;
              img.className = 'img-fluid w-100';
              mediaContent.appendChild(img);
              downloadLink.href = data.url;
            }
          } else {
            alert('Tải lên thất bại: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Lỗi:', error);
          alert('Đã xảy ra lỗi khi tải lên.');
          progressBar.style.display = 'none';
        });
      });
    }

    // Gắn sự kiện cho cả hai input
    handleUpload('imageUpload');
    handleUpload('videoUpload');
  </script>
  {% endif %}
  <!-- Header End -->
{% endblock body %}
